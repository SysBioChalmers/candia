Bootstrap: docker
From: continuumio/miniconda3

%files
    candia_env.yaml
    
%post
    mkdir -p /cephyr
    mkdir -p /local
    mkdir -p /apps
    mkdir -p /usr/share/lmod/lmod
    mkdir -p /var/hasplm
    mkdir -p /var/opt/thinlinc
    mkdir -p /usr/lib64
    touch /usr/lib64/libdlfaker.so
    touch /usr/lib64/libvglfaker.so
    touch /usr/bin/nvidia-smi

    apt-get update && apt install -y --no-install-recommends locales libgomp1 libstdc++6 # build-essential

	###
	# Workaround: Get a conda version higher than 4.8.2
	# Ref: https://github.com/conda/conda/issues/9681
	###
    /opt/conda/bin/conda update conda    
    /opt/conda/bin/conda env update --name base --file candia_env.yaml --prune

	###
	# Workaround: C libraries installed by conda as dependencies are a bit ouf date so, we use the system ones
	# Ref: https://conda.continuum.narkive.com/nGVLDlYz/r-jupyter-cxxabi-version-not-found
	###
	mv /opt/conda/lib/libstdc++.so.6 /opt/conda/lib/libstdc++.so.6_conda
	mv /opt/conda/lib/libgomp.so.1 /opt/conda/lib/libgomp.so.1_conda
	ln -s /usr/lib/x86_64-linux-gnu/libstdc++.so.6 /opt/conda/lib/libstdc++.so.6
	ln -s /usr/lib/x86_64-linux-gnu/libgomp.so.1 /opt/conda/lib/libgomp.so.1

    # Avoid warnings about locale
    echo 'en_US.UTF-8 UTF-8' >> /etc/locale.gen
    locale-gen && update-locale LANG=en_US.UTF-8


%environment
	export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/conda/lib


%runscript
    exec "$@"
